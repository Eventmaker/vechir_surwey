<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Опитування: Відеонагляд - Вечір Телеком</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind configuration - defines custom theme settings
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'bg-dark': '#12141D',       // Dark background from the site
                        'text-light': '#ffffff',
                        'text-secondary': '#cccccc',
                        'accent-blue': '#00aaff',  // Approximate blue accent
                        'accent-pink': '#ff00ff',  // Approximate pink/purple accent
                        'border-color': '#333',
                        'input-bg': '#2a2d35',
                        'input-bg-hover': '#3a3f4a',
                        'btn-disabled-bg': '#555',
                        'btn-disabled-text': '#999',
                        'error-bg': '#4d1f2a',     // Background for error messages
                        'error-border': '#ff4d6d', // Border for error messages
                        'error-text': '#ffcad4',   // Text color for error messages
                        // Added for glossy effect
                        'gloss-start': 'rgba(55, 65, 81, 0.95)', // gray-800 with opacity
                        'gloss-mid': 'rgba(0, 0, 0, 0.92)',     // black with opacity
                        'gloss-end': 'rgba(31, 41, 55, 0.95)',   // gray-900 with opacity
                        'gloss-border': 'rgba(75, 85, 99, 0.5)', // gray-700 with opacity
                    },
                    fontFamily: {
                        // Use 'Inter' as the primary font, fallback to system sans-serif
                        sans: ['Inter', 'Segoe UI', 'Tahoma', 'Geneva', 'Verdana', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom styles for elements not easily handled by Tailwind alone */
        body {
            background-image: linear-gradient(rgba(18, 20, 29, 0.85), rgba(18, 20, 29, 0.85)), url('https://vstore.net.ua/image/catalog/back.webp');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-color: theme('colors.bg-dark');
            color: theme('colors.text-light');
            font-family: theme('fontFamily.sans');
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        main { flex-grow: 1; }
        .progress-bar { background: linear-gradient(90deg, theme('colors.accent-blue'), theme('colors.accent-pink')); transition: width 0.3s ease-in-out; }
        input[type="radio"], input[type="checkbox"] { accent-color: theme('colors.accent-pink'); transform: scale(1.2); cursor: pointer; margin-right: 0.75rem; flex-shrink: 0; }

        input[type="text"]:not(:disabled), input[type="number"]:not(:disabled), input[type="tel"]:not(:disabled), input[type="email"]:not(:disabled), textarea:not(:disabled), .inline-input:not(:disabled), .form-input-conditional:not(:disabled) { color: theme('colors.accent-blue'); }
        ::placeholder { color: theme('colors.text-secondary / 60%'); opacity: 1; }
        input:disabled, textarea:disabled, .inline-input:disabled, .form-input-conditional:disabled { color: theme('colors.text-secondary'); opacity: 0.6; cursor: not-allowed; }

        input[type="text"]:focus, input[type="number"]:focus, input[type="tel"]:focus, input[type="email"]:focus, textarea:focus { outline: none; border-color: theme('colors.accent-blue'); box-shadow: 0 0 5px theme('colors.accent-blue'); }

        .survey-step { display: none; animation: fadeIn 0.5s; }
        .survey-step.active { display: block; }
         @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .form-group label i, .radio-label i, .checkbox-label i { width: 20px; text-align: center; flex-shrink: 0; margin-right: 0.75rem; }
        .radio-label, .checkbox-label { display: flex; align-items: center; padding: 0.75rem; background-color: theme('colors.input-bg'); border-radius: 0.375rem; cursor: pointer; transition: background-color 0.2s ease, border-color 0.2s ease; border: 1px solid transparent; }
        .radio-label:hover, .checkbox-label:hover { background-color: theme('colors.input-bg-hover'); border-color: theme('colors.accent-blue/50'); }

        .btn:not(:disabled):active { transform: scale(0.98); filter: brightness(0.9); }
        .btn:disabled { background-color: theme('colors.btn-disabled-bg'); color: theme('colors.btn-disabled-text'); cursor: not-allowed; opacity: 0.7; }

        #error-message-container { background-color: theme('colors.error-bg'); border: 1px solid theme('colors.error-border'); color: theme('colors.error-text'); padding: 0.75rem 1rem; border-radius: 0.375rem; margin-bottom: 1.25rem; display: none; transition: opacity 0.3s ease; }
        #error-message-container.visible { display: block; opacity: 1; }

        .inline-input { padding: 0.375rem 0.625rem; background-color: theme('colors.bg-dark'); border: 1px solid theme('colors.border-color'); border-radius: 0.25rem; transition: border-color 0.2s ease, box-shadow 0.2s ease; flex-grow: 1; }
        .inline-input:focus { border-color: theme('colors.accent-blue'); box-shadow: 0 0 3px theme('colors.accent-blue'); }

        .comm-pref-note { font-size: 0.8rem; color: theme('colors.text-secondary'); margin-left: calc(1.2em + 0.75rem + 0.75rem); margin-top: -0.25rem; padding-bottom: 0.5rem; display: block; }
        .conditional-input-container { margin-left: calc(1.2em + 0.75rem + 0.75rem); margin-top: 0.5rem; padding-bottom: 0.5rem; }
        .form-input-conditional { background-color: theme('colors.input-bg'); border: 1px solid theme('colors.border-color'); border-radius: 0.375rem; padding: 0.625rem; width: 100%; font-size: 0.875rem; transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .form-input-conditional:focus { outline: none; border-color: theme('colors.accent-blue'); box-shadow: 0 0 0 2px rgba(0, 170, 255, 0.3); }

        .glossy-bg { background: linear-gradient(180deg, rgba(55, 65, 81, 0.95), rgba(0, 0, 0, 0.92)); border: 1px solid theme('colors.gloss-border'); }
        .border-red-500 { border-color: #ef4444 !important; }
        label.border-red-500 { border-color: #ef4444 !important; background-color: rgba(239, 68, 68, 0.1); }

        /* Styles for conditionally shown fields */
        .conditional-fields { display: none; } /* Hidden by default */
        .conditional-fields.visible { display: block; animation: fadeIn 0.5s; } /* Shown with animation */

        /* Style for speech input button */
        #start-speech-btn {
            background-color: theme('colors.input-bg');
            border: 1px solid theme('colors.border-color');
            color: theme('colors.text-secondary');
            padding: 0.5rem;
            margin-left: 0.5rem;
            border-radius: 0.375rem; /* rounded-md */
            cursor: pointer;
            transition: all 0.2s ease;
        }
        #start-speech-btn:hover {
            background-color: theme('colors.input-bg-hover');
            color: theme('colors.accent-blue');
        }
        #start-speech-btn.listening {
            background-color: theme('colors.accent-pink');
            color: theme('colors.text-light');
            border-color: theme('colors.accent-pink');
        }
        #speech-status {
            font-size: 0.75rem; /* text-xs */
            color: theme('colors.text-secondary');
            margin-top: 0.25rem; /* mt-1 */
            height: 1em; /* Reserve space */
        }

    </style>
</head>
<body class="bg-bg-dark text-text-light font-sans leading-relaxed">

    <header class="flex flex-col sm:flex-row justify-between items-center p-3 sm:p-5 border-b border-border-color mb-5 bg-bg-dark/80 backdrop-blur-sm sticky top-0 z-10 shadow-md">
        <div class="flex items-center gap-3 mb-2 sm:mb-0">
             <img src="https://vechir.ua/wp-content/uploads/2021/03/logo_vechir_2021-02.svg" alt="Логотип Вечір Телеком Старий" class="h-10" onerror="this.style.display='none'">
             <div class="logo">
                 <img src="https://vechir.ua/wp-content/uploads/2021/03/logo_vechir_2021-03.svg" alt="Логотип Вечір Телеком" class="h-10" onerror="this.outerHTML='<span class=\'text-xl font-bold\'>Вечір Телеком</span>'">
             </div>
        </div>
        <div class="header-contact text-text-secondary text-sm sm:text-base">
             <i class="fa-solid fa-phone mr-1"></i>
             <a href="tel:0800303660" class="hover:text-text-light transition-colors">0 800 303 660</a> (Безкоштовно)
             </div>
    </header>


    <main class="container max-w-3xl mx-auto p-4 sm:p-5 glossy-bg rounded-lg shadow-xl mb-8">
        <section id="intro">
            <h2 class="text-2xl font-bold text-accent-blue text-center mb-5 flex items-center justify-center gap-2">
                 <i class="fa-solid fa-video"></i> Опитування щодо послуги "Відеонагляд"
            </h2>
            <p class="mb-3 text-text-secondary">Шановний абоненте,</p>
            <p class="mb-5 text-text-secondary">Дякуємо за Ваш інтерес до нової послуги "Відеонагляд" від "Вечір Телеком"! Ми прагнемо створити сервіс, який буде максимально відповідати Вашим потребам. Просимо Вас приділити кілька хвилин, щоб поділитися своєю думкою та допомогти нам зробити "Відеонагляд" зручним та простим.</p>

            <div class="flex flex-col md:flex-row items-center gap-8 my-8">
                 <div class="w-full md:w-1/3 flex justify-center items-center bg-black/20 rounded-lg p-2 shadow-inner">
                      <img src="https://vstore.net.ua/image/catalog/lmou1.webp"
                           alt="[Image of Зображення камери Imou Bullet 2E]"
                           class="block h-40 md:h-44 w-auto rounded-md"
                           onerror="this.onerror=null; this.src='https://placehold.co/200x160/2a2d35/cccccc?text=Камера+Imou'; this.classList.add('border', 'border-border-color');">
                 </div>
                 <div class="w-full md:w-2/3 prize-info bg-black/30 border border-accent-pink p-4 rounded-md text-center shadow-inner mt-6 md:mt-0">
                      <p class="mb-2 text-text-secondary">
                           <i class="fa-solid fa-gift text-accent-pink mr-2"></i> В якості подяки за участь в опитуванні, ми пропонуємо Вам можливість виграти зовнішню камеру відеоспостереження -
                           <a href="https://vstore.net.ua/ua/videosposterezhennia-i-bezpeka/kamery/3mp-h265-wi-f-bullet-2e-3mp-ipc-k3dp-3h0wf28mm-181592" target="_blank" rel="noopener noreferrer" class="text-accent-blue hover:underline font-semibold">Imou Bullet 2E</a>.
                      </p>
                      <p class="text-sm text-text-secondary"><strong>Дата розіграшу:</strong> [буде відома пізніше] | <strong>Платформа:</strong> Instagram</p>
                 </div>
            </div>

            <div class="text-center mt-8">
                 <button class="btn bg-accent-blue hover:bg-blue-500 text-text-light font-bold py-2.5 px-8 rounded-md uppercase transition-colors duration-300 shadow-md hover:shadow-lg" id="start-survey-btn">Розпочати опитування</button>
            </div>
        </section>

        <section id="survey-form" class="hidden">
            <form id="video-survey" novalidate>
                 <div class="progress-indicator mb-8">
                     <div class="progress-bar-container w-full bg-input-bg rounded-full h-2.5 overflow-hidden shadow-inner">
                         <div class="progress-bar h-full rounded-full" id="progress-bar" style="width: 0%;"></div>
                     </div>
                     <div class="progress-text text-center mt-2 text-sm text-text-secondary" id="progress-text">Крок 1 з 10</div>
                 </div>

                 <div id="error-message-container" role="alert">
                     <p id="error-message-text"></p>
                 </div>

                 <div class="survey-step active" data-step="1">
                     <h3 class="text-xl font-semibold text-accent-blue mb-4 flex items-center gap-2"><i class="fa-solid fa-user-check"></i> Питання 1: Статус абонента та контакти</h3>

                     <div class="form-group mb-5">
                         <label class="block mb-3 font-medium text-text-secondary">Ви є абонентом "Вечір Телеком"?<span class="text-accent-pink ml-1">*</span></label>
                         <div class="space-y-3">
                             <label class="radio-label">
                                 <input type="radio" name="is_subscriber" value="yes" required>
                                 <i class="fa-solid fa-check text-green-500"></i> Так
                             </label>
                             <label class="radio-label">
                                 <input type="radio" name="is_subscriber" value="no" required>
                                 <i class="fa-solid fa-times text-red-500"></i> Ні
                             </label>
                         </div>
                     </div>

                     <div id="subscriber-fields" class="conditional-fields mt-6 pt-4 border-t border-border-color/50">
                         <div class="form-group mb-5">
                             <label for="contract-number" class="block mb-2 font-medium text-text-secondary flex items-center">
                                <i class="fa-solid fa-file-contract"></i> Ваш номер договору (ППК)
                             </label>
                             <input type="text" id="contract-number" name="contract_number" placeholder="Введіть ваш Персональний платіжний код" class="w-full p-2.5 bg-input-bg border border-border-color rounded-md focus:border-accent-blue focus:ring-accent-blue focus:ring-1 transition">
                             <div class="mt-2">
                                 <label class="checkbox-label inline-flex !p-2 !bg-transparent">
                                     <input type="checkbox" id="contract-dont-remember" name="contract_dont_remember" value="yes">
                                     <span class="text-sm text-text-secondary">Не пам'ятаю номер договору</span>
                                 </label>
                             </div>
                             <p class="input-hint text-xs text-text-secondary mt-1">Якщо пам'ятаєте, вкажіть для ідентифікації.</p>
                         </div>
                     </div>

                     <div id="non-subscriber-fields" class="conditional-fields mt-6 pt-4 border-t border-border-color/50">
                          <p class="input-hint text-sm text-text-secondary mb-4">Будь ласка, вкажіть контактні дані, щоб ми могли повідомити Вас про **перемогу** у розіграші камери:</p>
                         <div class="form-group mb-5">
                             <label for="phone-number" class="block mb-2 font-medium text-text-secondary flex items-center">
                                 <i class="fa-solid fa-phone"></i> Ваш контактний номер телефону
                             </label>
                             <input type="tel" id="phone-number" name="phone_number" placeholder="+380 XX XXX XX XX" class="w-full p-2.5 bg-input-bg border border-border-color rounded-md focus:border-accent-blue focus:ring-accent-blue focus:ring-1 transition">
                             <p class="input-hint text-xs text-text-secondary mt-1">Потрібен для зв'язку у разі **перемоги**.</p>
                         </div>
                         <div class="text-center my-2 text-text-secondary font-medium">АБО</div>
                         <div class="form-group mb-5">
                            <label for="email-for-prize" class="block mb-2 font-medium text-text-secondary flex items-center">
                                <i class="fa-solid fa-at"></i> Ваш Email
                            </label>
                            <input type="email" id="email-for-prize" name="email_for_prize" placeholder="example@email.com" class="w-full p-2.5 bg-input-bg border border-border-color rounded-md focus:border-accent-blue focus:ring-accent-blue focus:ring-1 transition">
                             <p class="input-hint text-xs text-text-secondary mt-1">Потрібен для зв'язку у разі **перемоги**.</p>
                        </div>
                        <p class="input-hint text-sm text-red-400 mb-4">** Необхідно вказати принаймні один контакт: телефон АБО email.</p>
                     </div>

                     <div class="navigation-buttons flex flex-col-reverse sm:flex-row justify-between mt-8 pt-5 border-t border-border-color">
                         <button type="button" class="btn btn-back bg-input-bg hover:bg-input-bg-hover text-text-secondary border border-border-color font-bold py-2 px-6 rounded-md uppercase transition-colors duration-300 w-full sm:w-auto mb-2 sm:mb-0" disabled>Назад</button>
                         <button type="button" class="btn btn-next bg-accent-blue hover:bg-blue-500 text-text-light font-bold py-2 px-6 rounded-md uppercase transition-colors duration-300 w-full sm:w-auto">Далі</button>
                     </div>
                 </div>

                 <div class="survey-step" data-step="2">
                      <h3 class="text-xl font-semibold text-accent-blue mb-4 flex items-center gap-2"><i class="fa-solid fa-house-chimney-window"></i> Питання 2: Який тип приміщення? <span class="text-accent-pink ml-1">*</span></h3>
                      <div class="form-group space-y-3 mb-5">
                           <label class="radio-label">
                               <input type="radio" name="premise_type" value="Квартира" required>
                               <i class="fa-solid fa-building text-accent-blue"></i> Квартира
                           </label>
                           <label class="radio-label">
                               <input type="radio" name="premise_type" value="Приватний будинок">
                               <i class="fa-solid fa-house text-accent-blue"></i> Приватний будинок
                           </label>
                           <label class="radio-label">
                               <input type="radio" name="premise_type" value="Офіс">
                               <i class="fa-solid fa-briefcase text-accent-blue"></i> Офіс
                           </label>
                           <label class="radio-label">
                               <input type="radio" name="premise_type" value="Магазин">
                               <i class="fa-solid fa-store text-accent-blue"></i> Магазин
                           </label>
                           <label class="radio-label flex-wrap">
                               <input type="radio" name="premise_type" value="Інше">
                               <i class="fa-solid fa-question text-accent-blue"></i> Інше
                               <input type="text" name="premise_type_other" class="inline-input mt-2 sm:mt-0 sm:ml-2" placeholder="Вкажіть тип" disabled>
                           </label>
                      </div>
                      <div class="navigation-buttons flex flex-col-reverse sm:flex-row justify-between mt-8 pt-5 border-t border-border-color">
                           <button type="button" class="btn btn-back bg-input-bg hover:bg-input-bg-hover text-text-secondary border border-border-color font-bold py-2 px-6 rounded-md uppercase transition-colors duration-300 w-full sm:w-auto mb-2 sm:mb-0">Назад</button>
                           <button type="button" class="btn btn-next bg-accent-blue hover:bg-blue-500 text-text-light font-bold py-2 px-6 rounded-md uppercase transition-colors duration-300 w-full sm:w-auto">Далі</button>
                      </div>
                 </div>

                 <div class="survey-step" data-step="3">
                      <h3 class="text-xl font-semibold text-accent-blue mb-4 flex items-center gap-2"><i class="fa-solid fa-video-camera"></i> Питання 3: Чи користуєтесь Ви зараз системою відеоспостереження? <span class="text-accent-pink ml-1">*</span></h3>
                      <div class="form-group space-y-3 mb-5">
                           <label class="radio-label">
                               <input type="radio" name="using_now" value="Так" required data-next-step="5"> <i class="fa-solid fa-check text-green-500"></i> Так
                           </label>
                           <label class="radio-label">
                               <input type="radio" name="using_now" value="Ні" required data-next-step="4"> <i class="fa-solid fa-times text-red-500"></i> Ні
                           </label>
                      </div>
                      <div class="navigation-buttons flex flex-col-reverse sm:flex-row justify-between mt-8 pt-5 border-t border-border-color">
                           <button type="button" class="btn btn-back bg-input-bg hover:bg-input-bg-hover text-text-secondary border border-border-color font-bold py-2 px-6 rounded-md uppercase transition-colors duration-300 w-full sm:w-auto mb-2 sm:mb-0">Назад</button>
                           <button type="button" class="btn btn-next bg-accent-blue hover:bg-blue-500 text-text-light font-bold py-2 px-6 rounded-md uppercase transition-colors duration-300 w-full sm:w-auto">Далі</button>
                      </div>
                 </div>

                 <div class="survey-step" data-step="4">
                      <h3 class="text-xl font-semibold text-accent-blue mb-4 flex items-center gap-2"><i class="fa-solid fa-circle-question"></i> Питання 4: Оберіть основну причину, чому не користуєтесь <span class="text-accent-pink ml-1">*</span></h3>
                      <div class="form-group space-y-3 mb-5">
                           <label class="radio-label">
                                <input type="radio" name="reason_not_using" value="Висока вартість" required>
                                <i class="fa-solid fa-dollar-sign text-accent-blue"></i> Висока вартість
                           </label>
                           <label class="radio-label">
                                <input type="radio" name="reason_not_using" value="Складність встановлення">
                                <i class="fa-solid fa-screwdriver-wrench text-accent-blue"></i> Складність встановлення та налаштування
                           </label>
                           <label class="radio-label">
                                <input type="radio" name="reason_not_using" value="Необхідність обслуговування">
                                <i class="fa-solid fa-user-gear text-accent-blue"></i> Необхідність обслуговування
                           </label>
                           <label class="radio-label">
                                <input type="radio" name="reason_not_using" value="Недостатня обізнаність">
                                <i class="fa-solid fa-info-circle text-accent-blue"></i> Недостатня обізнаність про переваги
                           </label>
                           <label class="radio-label flex-wrap">
                                <input type="radio" name="reason_not_using" value="Інше">
                                <i class="fa-solid fa-question text-accent-blue"></i> Інше
                                <input type="text" name="reason_not_using_other" class="inline-input mt-2 sm:mt-0 sm:ml-2" placeholder="Вкажіть причину" disabled>
                           </label>
                      </div>
                      <div class="navigation-buttons flex flex-col-reverse sm:flex-row justify-between mt-8 pt-5 border-t border-border-color">
                           <button type="button" class="btn btn-back bg-input-bg hover:bg-input-bg-hover text-text-secondary border border-border-color font-bold py-2 px-6 rounded-md uppercase transition-colors duration-300 w-full sm:w-auto mb-2 sm:mb-0">Назад</button>
                           <button type="button" class="btn btn-next bg-accent-blue hover:bg-blue-500 text-text-light font-bold py-2 px-6 rounded-md uppercase transition-colors duration-300 w-full sm:w-auto">Далі</button>
                      </div>
                 </div>

                 <div class="survey-step" data-step="5">
                      <h3 class="text-xl font-semibold text-accent-blue mb-2 flex items-center gap-2">
                            <i class="fa-solid fa-bullseye"></i> Які Ваші основні цілі використання послуги відеоспостереження
                      </h3>
                      <p class="input-hint text-sm text-text-secondary mb-4">Оберіть 1-2 найважливіші пункти. <span class="text-accent-pink ml-1">*</span></p>
                      <div class="form-group space-y-3 mb-5">
                           <label class="checkbox-label">
                               <input type="checkbox" name="goals[]" value="Безпека">
                               <i class="fa-solid fa-shield-halved text-accent-blue"></i> Забезпечення безпеки та захист від крадіжок
                           </label>
                           <label class="checkbox-label">
                               <input type="checkbox" name="goals[]" value="Контроль">
                               <i class="fa-solid fa-users-viewfinder text-accent-blue"></i> Контроль за дітьми/персоналом/територією
                           </label>
                           <label class="checkbox-label">
                               <input type="checkbox" name="goals[]" value="Докази">
                               <i class="fa-solid fa-file-video text-accent-blue"></i> Отримання доказів у разі інцидентів
                           </label>
                           <label class="checkbox-label">
                               <input type="checkbox" name="goals[]" value="Спокій">
                               <i class="fa-solid fa-face-smile-beam text-accent-blue"></i> Спокій та впевненість
                           </label>
                           <label class="checkbox-label flex-wrap">
                               <input type="checkbox" name="goals[]" value="Інше">
                               <i class="fa-solid fa-question text-accent-blue"></i> Інше
                               <input type="text" name="goals_other" class="inline-input mt-2 sm:mt-0 sm:ml-2" placeholder="Вкажіть ціль" disabled>
                           </label>
                      </div>
                       <div class="navigation-buttons flex flex-col-reverse sm:flex-row justify-between mt-8 pt-5 border-t border-border-color">
                           <button type="button" class="btn btn-back bg-input-bg hover:bg-input-bg-hover text-text-secondary border border-border-color font-bold py-2 px-6 rounded-md uppercase transition-colors duration-300 w-full sm:w-auto mb-2 sm:mb-0">Назад</button>
                           <button type="button" class="btn btn-next bg-accent-blue hover:bg-blue-500 text-text-light font-bold py-2 px-6 rounded-md uppercase transition-colors duration-300 w-full sm:w-auto">Далі</button>
                      </div>
                 </div>

                 <div class="survey-step" data-step="6">
                      <h3 class="text-xl font-semibold text-accent-blue mb-4 flex items-center gap-2"><i class="fa-solid fa-hand-holding-dollar"></i> Питання 6: Модель оплати та бюджет <span class="text-accent-pink ml-1">*</span></h3>
                      <p class="input-hint text-sm text-text-secondary mb-4">Який підхід до оплати та щомісячний бюджет на сервісну частину (технічне обслуговування, заміна обладнання) для Вас оптимальний?<span class="text-accent-pink ml-1">*</span></p>
                      <div class="form-group space-y-3 mb-5">
                           <label class="radio-label">
                               <input type="radio" name="payment_model_budget" value="purchase" required>
                               <i class="fa-solid fa-credit-card text-accent-blue"></i> Одноразова купівля обладнання(з оплатою за технічне обслуговування по факту)
                           </label>
                           <label class="radio-label">
                               <input type="radio" name="payment_model_budget" value="rent_under_300">
                               <i class="fa-solid fa-calendar-days text-accent-blue"></i> Щомісячна абонплата до 300 грн (оренда обладнання + сервіс)
                           </label>
                           <label class="radio-label">
                               <input type="radio" name="payment_model_budget" value="rent_300_500">
                               <i class="fa-solid fa-calendar-days text-accent-blue"></i> Щомісячна абонплата 300-500 грн (оренда обладнання + сервіс)
                           </label>
                           <label class="radio-label">
                               <input type="radio" name="payment_model_budget" value="rent_500_800">
                               <i class="fa-solid fa-calendar-days text-accent-blue"></i> Щомісячна абонплата 500-800 грн (оренда обладнання + сервіс)
                           </label>
                           <label class="radio-label">
                               <input type="radio" name="payment_model_budget" value="rent_over_800">
                               <i class="fa-solid fa-calendar-days text-accent-blue"></i> Щомісячна абонплата > 800 грн (оренда обладнання + сервіс)
                           </label>
                           <label class="radio-label">
                               <input type="radio" name="payment_model_budget" value="undecided">
                               <i class="fa-solid fa-circle-question text-accent-blue"></i> Важко сказати / Залежить від умов
                           </label>
                      </div>
                      <div class="navigation-buttons flex flex-col-reverse sm:flex-row justify-between mt-8 pt-5 border-t border-border-color">
                           <button type="button" class="btn btn-back bg-input-bg hover:bg-input-bg-hover text-text-secondary border border-border-color font-bold py-2 px-6 rounded-md uppercase transition-colors duration-300 w-full sm:w-auto mb-2 sm:mb-0">Назад</button>
                           <button type="button" class="btn btn-next bg-accent-blue hover:bg-blue-500 text-text-light font-bold py-2 px-6 rounded-md uppercase transition-colors duration-300 w-full sm:w-auto">Далі</button>
                      </div>
                 </div>

                 <div class="survey-step" data-step="7">
                     <h3 class="text-xl font-semibold text-accent-blue mb-4 flex items-center gap-2"><i class="fa-solid fa-sliders"></i> Питання 7: Бажані налаштування системи</h3>

                     <div class="mb-6">
                         <label class="block mb-3 font-medium text-text-secondary"><i class="fa-solid fa-camera-retro mr-2"></i>Необхідна кількість камер <span class="text-accent-pink ml-1">*</span></label>
                         <div class="form-group space-y-3">
                              <label class="radio-label">
                                  <input type="radio" name="camera_count" value="1" required> 1
                              </label>
                              <label class="radio-label">
                                  <input type="radio" name="camera_count" value="2-3"> 2-3
                              </label>
                              <label class="radio-label">
                                  <input type="radio" name="camera_count" value="4-5"> 4-5
                              </label>
                              <label class="radio-label">
                                  <input type="radio" name="camera_count" value=">5"> Більше 5
                              </label>
                         </div>
                     </div>

                     <div class="pt-4 border-t border-border-color/50">
                         <label class="block mb-3 font-medium text-text-secondary"><i class="fa-solid fa-list-check mr-2"></i>Бажані функції <span class="text-accent-pink ml-1">*</span></label>
                         <div class="form-group space-y-3 mb-5">
                              <label class="checkbox-label">
                                  <input type="checkbox" name="features[]" value="Нічна зйомка"> <i class="fa-solid fa-moon text-accent-blue"></i> Нічна зйомка
                              </label>
                              <label class="checkbox-label">
                                  <input type="checkbox" name="features[]" value="Віддалений доступ"> <i class="fa-solid fa-mobile-screen-button text-accent-blue"></i> Віддалений доступ (телефон/комп'ютер)
                              </label>
                              <label class="checkbox-label">
                                  <input type="checkbox" name="features[]" value="Висока якість запису"> <i class="fa-solid fa-film text-accent-blue"></i> Висока якість запису (HD/FullHD+)
                              </label>
                              <label class="checkbox-label">
                                  <input type="checkbox" name="features[]" value="Датчики руху"> <i class="fa-solid fa-person-running text-accent-blue"></i> Датчики руху
                              </label>
                              <label class="checkbox-label flex-wrap">
                                  <input type="checkbox" name="features[]" value="Зберігання записів"> <i class="fa-solid fa-cloud-arrow-up text-accent-blue"></i> Зберігання записів
                                  <span class="ml-1 mr-1 mt-2 sm:mt-0 text-sm text-text-secondary">(бажаний період:</span>
                                  <input type="number" name="storage_days" min="1" placeholder="днів" class="inline-input p-1 w-16 text-center mt-2 sm:mt-0" disabled>
                                  <span class="ml-1 mt-2 sm:mt-0 text-sm text-text-secondary"> днів)</span>
                              </label>
                              <label class="checkbox-label flex-wrap">
                                  <input type="checkbox" name="features[]" value="Отримання сповіщень"> <i class="fa-solid fa-bell text-accent-blue"></i> Отримання сповіщень
                                   <span class="ml-1 mr-1 mt-2 sm:mt-0 text-sm text-text-secondary">(зручний спосіб:</span>
                                   <input type="text" name="notification_method" placeholder="напр., Telegram, SMS" class="inline-input p-1 mt-2 sm:mt-0 sm:ml-1" disabled>
                                   <span class="ml-1 mt-2 sm:mt-0 text-sm text-text-secondary">)</span>
                              </label>
                         </div>
                           <p class="input-hint text-xs text-text-secondary -mt-3 mb-4">Оберіть хоча б одну функцію.</p> </div>

                     <div class="navigation-buttons flex flex-col-reverse sm:flex-row justify-between mt-8 pt-5 border-t border-border-color">
                          <button type="button" class="btn btn-back bg-input-bg hover:bg-input-bg-hover text-text-secondary border border-border-color font-bold py-2 px-6 rounded-md uppercase transition-colors duration-300 w-full sm:w-auto mb-2 sm:mb-0">Назад</button>
                          <button type="button" class="btn btn-next bg-accent-blue hover:bg-blue-500 text-text-light font-bold py-2 px-6 rounded-md uppercase transition-colors duration-300 w-full sm:w-auto">Далі</button>
                     </div>
                 </div>

                 <div class="survey-step" data-step="8">
                     <h3 class="text-xl font-semibold text-accent-blue mb-4 flex items-center gap-2"><i class="fa-solid fa-puzzle-piece"></i> Питання 8: Додаткові послуги та підтримка</h3>
                     <div class="form-group space-y-4 mb-5">
                         <div>
                             <label class="checkbox-label">
                                 <input type="checkbox" name="needs_consultation" value="yes">
                                 <i class="fa-solid fa-headset text-accent-blue"></i> Бажаю отримати консультацію щодо підбору та налаштування
                             </label>
                         </div>
                         <div>
                             <label class="checkbox-label">
                                 <input type="checkbox" id="interested-other-services-cb" name="interested_other_services" value="yes">
                                 <i class="fa-solid fa-shield-dog text-accent-blue"></i> Цікавлять інші послуги безпеки (напр., датчики, сигналізація)
                             </label>
                             <div id="other-services-details-container" class="conditional-input-container hidden">
                                  <label for="other_services_details" class="block mb-1 text-sm font-medium text-text-secondary">Будь ласка, вкажіть, які саме послуги Вас цікавлять:</label>
                                  <input type="text" id="other_services_details" name="other_services_details" placeholder="Наприклад: датчики руху, диму..." class="form-input-conditional">
                             </div>
                         </div>
                     </div>
                     <div class="navigation-buttons flex flex-col-reverse sm:flex-row justify-between mt-8 pt-5 border-t border-border-color">
                         <button type="button" class="btn btn-back bg-input-bg hover:bg-input-bg-hover text-text-secondary border border-border-color font-bold py-2 px-6 rounded-md uppercase transition-colors duration-300 w-full sm:w-auto mb-2 sm:mb-0">Назад</button>
                         <button type="button" class="btn btn-next bg-accent-blue hover:bg-blue-500 text-text-light font-bold py-2 px-6 rounded-md uppercase transition-colors duration-300 w-full sm:w-auto">Далі</button>
                     </div>
                 </div>

                 <div class="survey-step" data-step="9">
                     <h3 class="text-xl font-semibold text-accent-blue mb-2 flex items-center gap-2"><i class="fa-solid fa-envelope-open-text"></i> Питання 9: Бажані способи зв'язку</h3>
                     <p class="input-hint text-sm text-text-secondary mb-4">Оберіть зручні канали для отримання важливих повідомлень від нас (стан послуг, акції, новини):</p>
                     <div class="form-group space-y-1 mb-5">
                          <div>
                              <label class="checkbox-label">
                                   <input type="checkbox" id="comm-viber" name="communication_prefs[]" value="viber">
                                   <i class="fab fa-viber text-purple-500"></i> Viber
                              </label>
                              <div id="viber-phone-container" class="conditional-input-container hidden">
                                  <label for="viber-phone-number" class="block mb-1 text-sm font-medium text-text-secondary">Номер телефону для Viber:<span class="text-accent-pink ml-1">*</span></label>
                                  <input type="tel" id="viber-phone-number" name="viber_phone_number" class="form-input-conditional" placeholder="+380 XX XXX XX XX">
                              </div>
                              </div>
                          <div>
                              <label class="checkbox-label">
                                   <input type="checkbox" id="comm-telegram" name="communication_prefs[]" value="telegram">
                                   <i class="fab fa-telegram text-sky-500"></i> Telegram Бот
                              </label>
                               <span class="comm-pref-note">Ми надішлемо запрошення до нашого інформаційного боту.</span>
                               <div id="telegram-username-container" class="conditional-input-container hidden">
                                   <label for="telegram-username" class="block mb-1 text-sm font-medium text-text-secondary">Ваш Telegram username (необов'язково):</label>
                                   <input type="text" id="telegram-username" name="telegram_username" class="form-input-conditional" placeholder="@username">
                               </div>
                          </div>
                          <div>
                              <label class="checkbox-label">
                                   <input type="checkbox" id="comm-email" name="communication_prefs[]" value="email">
                                   <i class="fa-solid fa-at text-red-500"></i> Email
                              </label>
                              <div id="email-input-container" class="conditional-input-container hidden">
                                   <label for="email-address" class="block mb-1 text-sm font-medium text-text-secondary">Ваша Email адреса:<span class="text-accent-pink ml-1">*</span></label>
                                   <input type="email" id="email-address" name="email_address" class="form-input-conditional" placeholder="example@email.com">
                              </div>
                          </div>
                          <div>
                              <label class="checkbox-label">
                                   <input type="checkbox" id="comm-sms" name="communication_prefs[]" value="sms">
                                   <i class="fa-solid fa-comment-sms text-green-500"></i> SMS
                              </label>
                              <span class="comm-pref-note">На номер телефону, вказаний раніше (якщо Ви не абонент і вказали його на кроці 1).</span>
                          </div>
                           <div class="pt-3">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="comm-none" name="communication_prefs_optout" value="none">
                                    <i class="fa-solid fa-comment-slash text-gray-500"></i> Не бажаю отримувати додаткові інформаційні повідомлення
                                </label>
                           </div>
                     </div>
                     <div class="navigation-buttons flex flex-col-reverse sm:flex-row justify-between mt-8 pt-5 border-t border-border-color">
                          <button type="button" class="btn btn-back bg-input-bg hover:bg-input-bg-hover text-text-secondary border border-border-color font-bold py-2 px-6 rounded-md uppercase transition-colors duration-300 w-full sm:w-auto mb-2 sm:mb-0">Назад</button>
                          <button type="button" class="btn btn-next bg-accent-blue hover:bg-blue-500 text-text-light font-bold py-2 px-6 rounded-md uppercase transition-colors duration-300 w-full sm:w-auto">Далі</button>
                     </div>
                 </div>

                 <div class="survey-step" data-step="10">
                      <h3 class="text-xl font-semibold text-accent-blue mb-4 flex items-center gap-2"><i class="fa-solid fa-pen-to-square"></i> Питання 10: Ваші побажання та коментарі</h3>
                      <div class="form-group mb-5">
                           <label for="comments" class="block mb-2 font-medium text-text-secondary">Розкажіть, що ще важливо для Вас у послузі відеоспостереження?</label>
                           <div class="flex items-start">
                               <textarea id="comments" name="comments" rows="4" placeholder="Напишіть Ваші думки тут або використайте мікрофон..." class="flex-grow p-2.5 bg-input-bg border border-border-color rounded-md focus:border-accent-blue focus:ring-accent-blue focus:ring-1 transition resize-vertical"></textarea>
                               <button type="button" id="start-speech-btn" title="Голосовий ввід" class="flex-shrink-0">
                                   <i class="fa-solid fa-microphone"></i>
                               </button>
                           </div>
                           <div id="speech-status" class="text-xs text-text-secondary mt-1 h-4"></div> </div>
                      <div class="navigation-buttons flex flex-col-reverse sm:flex-row justify-between mt-8 pt-5 border-t border-border-color">
                           <button type="button" class="btn btn-back bg-input-bg hover:bg-input-bg-hover text-text-secondary border border-border-color font-bold py-2 px-6 rounded-md uppercase transition-colors duration-300 w-full sm:w-auto mb-2 sm:mb-0">Назад</button>
                           <button type="button" class="btn btn-submit bg-accent-pink hover:bg-pink-700 text-text-light font-bold py-2 px-6 rounded-md uppercase transition-colors duration-300 w-full sm:w-auto">Відправити</button>
                      </div>
                 </div>

            </form>
        </section>

        <section id="success-message" class="hidden text-center p-10">
             <i class="fa-solid fa-circle-check text-6xl text-accent-pink mb-6 block animate-pulse"></i>
             <h2 class="text-3xl font-bold text-accent-blue mb-4">Дякуємо за Ваші відповіді!</h2>
             <p class="mb-3 text-lg text-text-secondary">Ваша думка дуже важлива для нас і допоможе зробити послугу "Відеонагляд" ще кращою.</p>
             <p class="text-lg text-text-secondary">Бажаємо успіху в розіграші камери Imou Bullet 2E!</p>
             <div class="mt-8">
                 <a href="https://eventmaker.github.io/vechir_video/"
                    target="_blank" rel="noopener noreferrer"
                    class="btn bg-accent-blue hover:bg-blue-500 text-text-light font-bold py-2 px-6 rounded-md uppercase transition-colors duration-300 shadow-md hover:shadow-lg">
                     Переглянути тарифи
                 </a>
             </div>
        </section>

    </main>

    <footer class="text-center mt-auto py-4 text-sm text-text-secondary border-t border-border-color bg-bg-dark/80">
        © Вечір Телеком, 2025. Всі права захищено.
    </footer>

<script>
    // JavaScript logic updated for Step 1, Step 9 (Viber), Step 10 (Speech) and validation
    document.addEventListener('DOMContentLoaded', function() {
        // --- DOM Element References ---
        const introSection = document.getElementById('intro');
        const surveyFormSection = document.getElementById('survey-form');
        const successMessageSection = document.getElementById('success-message');
        const startBtn = document.getElementById('start-survey-btn');
        const form = document.getElementById('video-survey');
        const steps = form.querySelectorAll('.survey-step');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const errorContainer = document.getElementById('error-message-container');
        const errorTextElement = document.getElementById('error-message-text');
        const totalSteps = steps.length; // 10 steps
        let currentStep = 1;
        const history = [1];

        // --- References for Step 1 ---
        const subscriberRadios = form.querySelectorAll('input[name="is_subscriber"]');
        const subscriberFields = document.getElementById('subscriber-fields');
        const nonSubscriberFields = document.getElementById('non-subscriber-fields');
        const contractNumberInput = document.getElementById('contract-number');
        const contractDontRememberCheckbox = document.getElementById('contract-dont-remember');
        const phoneNumberInput = document.getElementById('phone-number');
        const emailForPrizeInput = document.getElementById('email-for-prize');

        // --- References for Communication Preferences (Step 9) ---
        const commViberCheckbox = document.getElementById('comm-viber');
        const commTelegramCheckbox = document.getElementById('comm-telegram');
        const commEmailCheckbox = document.getElementById('comm-email');
        const commSmsCheckbox = document.getElementById('comm-sms');
        const commNoneCheckbox = document.getElementById('comm-none');
        const viberPhoneContainer = document.getElementById('viber-phone-container'); // New
        const viberPhoneNumberInput = document.getElementById('viber-phone-number'); // New
        const telegramContainer = document.getElementById('telegram-username-container');
        const emailContainer = document.getElementById('email-input-container');
        const emailInput = document.getElementById('email-address');
        const telegramInput = document.getElementById('telegram-username');
        const communicationCheckboxes = [commViberCheckbox, commTelegramCheckbox, commEmailCheckbox, commSmsCheckbox];

        // --- References for Additional Services (Step 8) ---
        const interestedOtherServicesCheckbox = document.getElementById('interested-other-services-cb');
        const otherServicesDetailsContainer = document.getElementById('other-services-details-container');
        const otherServicesDetailsInput = document.getElementById('other_services_details');

        // --- References for Speech Input (Step 10) ---
        const commentsTextarea = document.getElementById('comments');
        const speechButton = document.getElementById('start-speech-btn');
        const speechStatus = document.getElementById('speech-status');
        let recognition;
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let isRecognitionSupported = false;
        if (SpeechRecognition) {
            isRecognitionSupported = true;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'uk-UA';
            recognition.interimResults = false;
        } else {
             if(speechButton) speechButton.style.display = 'none';
             if(speechStatus) speechStatus.textContent = 'Голосовий ввід не підтримується.';
        }

        // --- Helper Functions ---
        function updateProgress() {
            const progressPercentage = totalSteps > 1 ? ((currentStep -1) / (totalSteps -1)) * 100 : (currentStep >= totalSteps ? 100 : 0);
            progressBar.style.width = `${progressPercentage}%`;
            progressText.textContent = `Крок ${currentStep} з ${totalSteps}`;
        }

        function showStep(stepNumber) {
            steps.forEach(step => step.classList.remove('active'));
            const stepToShow = form.querySelector(`.survey-step[data-step="${stepNumber}"]`);
            if (stepToShow) {
                stepToShow.classList.add('active');
                currentStep = stepNumber;
                const backBtn = stepToShow.querySelector('.btn-back');
                if (backBtn) backBtn.disabled = history.length <= 1;
                updateProgress();
                hideError();
                const headerHeight = document.querySelector('header')?.offsetHeight || 60;
                const elementTop = surveyFormSection.getBoundingClientRect().top + window.pageYOffset - headerHeight - 20;
                 window.scrollTo({ top: elementTop, behavior: 'smooth' });
            } else {
                console.error("Step not found:", stepNumber);
            }
        }

        function showError(message) {
            errorTextElement.textContent = message;
            errorContainer.classList.add('visible');
            errorContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function hideError() {
            errorContainer.classList.remove('visible');
            errorTextElement.textContent = '';
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

         function isValidPhone(phone) {
            const phoneRegex = /^[+\-\s\(\)0-9]{7,}$/;
            const digitCount = (phone.match(/\d/g) || []).length;
            return phoneRegex.test(phone) && digitCount >= 7;
         }

        /** Validates the inputs within the currently active step. */
        function validateStep(currentStepElement) {
            let isValid = true;
            let firstInvalidElement = null;
            const currentStepNumber = parseInt(currentStepElement.dataset.step);

            currentStepElement.querySelectorAll('.border-red-500').forEach(el => {
                el.classList.remove('border-red-500');
                if (el.tagName === 'LABEL' && (el.classList.contains('radio-label') || el.classList.contains('checkbox-label'))) {
                    el.style.backgroundColor = '';
                }
            });
            hideError();

            // --- Step 1 Specific Validation ---
            if (currentStepNumber === 1) {
                const isSubscriberSelected = form.querySelector('input[name="is_subscriber"]:checked');
                if (!isSubscriberSelected) {
                    isValid = false;
                    showError('Будь ласка, вкажіть, чи є Ви нашим абонентом.');
                    const firstRadioLabel = form.querySelector('input[name="is_subscriber"]')?.closest('label');
                    if (firstRadioLabel) {
                        firstRadioLabel.classList.add('border-red-500');
                        if (!firstInvalidElement) firstInvalidElement = form.querySelector('input[name="is_subscriber"]');
                    }
                } else if (isSubscriberSelected.value === 'no') {
                    // If "No", require Phone OR Email for prize
                    const phoneValue = phoneNumberInput.value.trim();
                    const emailValue = emailForPrizeInput.value.trim();
                    let contactValid = false;
                    let phoneFormatValid = true;
                    let emailFormatValid = true;

                    if (phoneValue && isValidPhone(phoneValue)) {
                        contactValid = true;
                    } else if (phoneValue && !isValidPhone(phoneValue)) {
                        phoneFormatValid = false;
                    }

                    if (emailValue && isValidEmail(emailValue)) {
                        contactValid = true;
                    } else if (emailValue && !isValidEmail(emailValue)) {
                        emailFormatValid = false;
                    }

                    if (!contactValid) {
                         isValid = false;
                         showError('Будь ласка, вкажіть дійсний номер телефону АБО email для повідомлення про перемогу.');
                         if (!phoneFormatValid && phoneValue) {
                             phoneNumberInput.classList.add('border-red-500');
                             if (!firstInvalidElement) firstInvalidElement = phoneNumberInput;
                         } else if (!emailFormatValid && emailValue) {
                             emailForPrizeInput.classList.add('border-red-500');
                             if (!firstInvalidElement) firstInvalidElement = emailForPrizeInput;
                         } else {
                             phoneNumberInput.classList.add('border-red-500');
                             emailForPrizeInput.classList.add('border-red-500');
                             if (!firstInvalidElement) firstInvalidElement = phoneNumberInput;
                         }
                    } else {
                         if (!phoneFormatValid && phoneValue) {
                             isValid = false;
                             showError('Будь ласка, перевірте формат номеру телефону.');
                             phoneNumberInput.classList.add('border-red-500');
                             if (!firstInvalidElement) firstInvalidElement = phoneNumberInput;
                         }
                         if (!emailFormatValid && emailValue) {
                             isValid = false;
                             showError('Будь ласка, перевірте формат Email адреси.');
                             emailForPrizeInput.classList.add('border-red-500');
                             if (!firstInvalidElement) firstInvalidElement = emailForPrizeInput;
                         }
                    }
                }
            } else {
                // --- General Validation for other steps ---
                const requiredInputs = currentStepElement.querySelectorAll('[required]');
                requiredInputs.forEach(input => {
                    if (!input.closest('.survey-step.active') || input.offsetParent === null || input.disabled) return;

                    let inputValid = true;
                    const inputWrapper = (input.type === 'radio' || input.type === 'checkbox') ? input.closest('label') : input;

                    if (input.type === 'radio') {
                        const groupName = input.name;
                        if (!currentStepElement.querySelector(`input[name="${groupName}"]:checked`)) {
                            inputValid = false;
                            const firstRadioLabel = currentStepElement.querySelector(`input[name="${groupName}"]`)?.closest('label');
                            if (firstRadioLabel && !firstRadioLabel.classList.contains('border-red-500')) {
                                firstRadioLabel.classList.add('border-red-500');
                                if (!firstInvalidElement) firstInvalidElement = currentStepElement.querySelector(`input[name="${groupName}"]`);
                            }
                        }
                    } else if (input.type === 'checkbox' && input.hasAttribute('required') && input.name.endsWith('[]')) {
                         const groupName = input.name;
                         if (currentStepElement.querySelectorAll(`input[name="${groupName}"]:checked`).length === 0) {
                            inputValid = false;
                            const firstCheckboxLabel = currentStepElement.querySelector(`input[name="${groupName}"]`)?.closest('label');
                            if (firstCheckboxLabel && !firstCheckboxLabel.classList.contains('border-red-500')) {
                                 firstCheckboxLabel.classList.add('border-red-500');
                                 if (!firstInvalidElement) firstInvalidElement = currentStepElement.querySelector(`input[name="${groupName}"]`);
                            }
                         }
                    } else if ((input.type === 'text' || input.type === 'number' || input.type === 'textarea' || input.type === 'email' || input.type === 'tel') && input.hasAttribute('required') && !input.value.trim()) {
                        inputValid = false;
                    } else if (input.type === 'email' && input.hasAttribute('required') && input.value.trim() && !isValidEmail(input.value.trim())) {
                        // Validation for required email fields (like comms email)
                        inputValid = false;
                        showError('Будь ласка, введіть дійсну адресу електронної пошти.');
                    } else if (input.type === 'tel' && input.hasAttribute('required') && input.value.trim() && !isValidPhone(input.value.trim())) {
                        // Validation for required phone fields (like Viber phone)
                         inputValid = false;
                         showError('Будь ласка, введіть дійсний номер телефону.');
                    }


                    if (!inputValid && inputWrapper) {
                         inputWrapper.classList.add('border-red-500');
                         if (!firstInvalidElement) firstInvalidElement = input;
                    }
                    if (!inputValid) isValid = false;
                });
            }

            // --- Specific Step Validations (Continued) ---
            if (currentStepNumber === 5) { // Goals
                const goalsCheckedCount = currentStepElement.querySelectorAll('input[name="goals[]"]:checked').length;
                 if (goalsCheckedCount === 0 && isValid) {
                     isValid = false;
                     showError('Будь ласка, оберіть хоча б одну ціль.');
                     const firstGoalLabel = currentStepElement.querySelector('input[name="goals[]"]').closest('label');
                     if (firstGoalLabel) { firstGoalLabel.classList.add('border-red-500'); if (!firstInvalidElement) firstInvalidElement = currentStepElement.querySelector('input[name="goals[]"]'); }
                 } else if (goalsCheckedCount > 2) {
                    isValid = false;
                    showError('Будь ласка, оберіть не більше двох цілей.');
                    currentStepElement.querySelectorAll('input[name="goals[]"]:checked').forEach(cb => { const label = cb.closest('label'); if(label) label.classList.add('border-red-500'); if (!firstInvalidElement) firstInvalidElement = cb; });
                }
            } else if (currentStepNumber === 7) { // Combined Step (Features part validation)
                  const featuresCheckedCount = currentStepElement.querySelectorAll('input[name="features[]"]:checked').length;
                  if (featuresCheckedCount === 0 && isValid) {
                      isValid = false;
                      showError('Будь ласка, оберіть хоча б одну бажану функцію.');
                      const firstFeatureLabel = currentStepElement.querySelector('input[name="features[]"]').closest('label');
                       if (firstFeatureLabel) { firstFeatureLabel.classList.add('border-red-500'); if (!firstInvalidElement) firstInvalidElement = currentStepElement.querySelector('input[name="features[]"]'); }
                  }
             } else if (currentStepNumber === 9) { // Communication Prefs (Email/Viber validation if checked)
                 if (commEmailCheckbox && commEmailCheckbox.checked && emailInput && !emailInput.value.trim()) {
                     // Handled by general required check
                 } else if (commEmailCheckbox && commEmailCheckbox.checked && emailInput && emailInput.value.trim() && !isValidEmail(emailInput.value.trim())) {
                     // Handled by general email format check
                 }
                 if (commViberCheckbox && commViberCheckbox.checked && viberPhoneNumberInput && !viberPhoneNumberInput.value.trim()) {
                    // Handled by general required check
                 } else if (commViberCheckbox && commViberCheckbox.checked && viberPhoneNumberInput && viberPhoneNumberInput.value.trim() && !isValidPhone(viberPhoneNumberInput.value.trim())) {
                     // Handled by general phone format check
                 }
             }

            // --- Validation for Dependent "Other" Text Inputs ---
            const otherInputsLogic = [
                { checkboxSelector: 'input[name="premise_type"][value="Інше"]:checked', textInputName: 'premise_type_other' },
                { checkboxSelector: 'input[name="reason_not_using"][value="Інше"]:checked', textInputName: 'reason_not_using_other' },
                { checkboxSelector: 'input[name="goals[]"][value="Інше"]:checked', textInputName: 'goals_other' },
                { checkboxSelector: 'input[name="features[]"][value="Зберігання записів"]:checked', textInputName: 'storage_days' },
                { checkboxSelector: 'input[name="features[]"][value="Отримання сповіщень"]:checked', textInputName: 'notification_method' },
                { checkboxSelector: 'input[name="interested_other_services"][value="yes"]:checked', textInputName: 'other_services_details' }
            ];
            if (isValid) {
                otherInputsLogic.forEach(logic => {
                     const checkbox = currentStepElement.querySelector(logic.checkboxSelector);
                     if (checkbox) {
                         const textInput = currentStepElement.querySelector(`[name="${logic.textInputName}"]`);
                         if (textInput && textInput.required && !textInput.value.trim()) {
                             isValid = false;
                             showError(`Будь ласка, заповніть поле "${textInput.placeholder || logic.textInputName}" оскільки Ви обрали відповідну опцію.`);
                             textInput.classList.add('border-red-500');
                             if (!firstInvalidElement) firstInvalidElement = textInput;
                         }
                     }
                });
            }


            if (!isValid && !errorContainer.classList.contains('visible')) {
                showError('Будь ласка, заповніть або виберіть значення для всіх обов\'язкових полів, позначених *. ');
            }

            if (firstInvalidElement) {
                firstInvalidElement.focus();
            }

            return isValid;
        }


        // --- Event Handlers ---
        startBtn.addEventListener('click', () => {
            introSection.style.display = 'none';
            surveyFormSection.style.display = 'block';
            showStep(1);
        });

        form.addEventListener('click', function(event) {
            const target = event.target;

            if (target.classList.contains('btn-next')) {
                const currentStepElement = target.closest('.survey-step');
                const currentStepNumber = parseInt(currentStepElement.dataset.step);
                if (!validateStep(currentStepElement)) return;

                let nextStepNumber = currentStepNumber + 1;
                if (currentStepNumber === 3) {
                    const usingNowChecked = form.querySelector('input[name="using_now"]:checked');
                    if (usingNowChecked) nextStepNumber = parseInt(usingNowChecked.dataset.nextStep);
                    else return;
                } else if (currentStepNumber === 4) {
                    nextStepNumber = 5;
                }

                if (nextStepNumber <= totalSteps) {
                    if (history[history.length - 1] !== nextStepNumber) history.push(nextStepNumber);
                    showStep(nextStepNumber);
                }
            } else if (target.classList.contains('btn-back')) {
                if (history.length > 1) {
                    history.pop();
                    showStep(history[history.length - 1]);
                }
            } else if (target.classList.contains('btn-submit')) {
                 const currentStepElement = target.closest('.survey-step');
                 if (!validateStep(currentStepElement)) return;
                console.log('Form submitted!');
                const formData = new FormData(form);
                const data = {};
                formData.forEach((value, key) => {
                    if (key.endsWith('[]')) {
                        if (!data[key]) data[key] = [];
                        data[key].push(value);
                    } else if (key.endsWith('_other') || key === 'storage_days' || key === 'notification_method' || key === 'other_services_details' || key === 'telegram_username' || key === 'comments' || key === 'contract_number' || key === 'phone_number' || key === 'email_for_prize' || key === 'viber_phone_number') {
                         if (value.trim() !== '') data[key] = value.trim();
                    } else if (key === 'needs_consultation' || key === 'interested_other_services' || key === 'communication_prefs_optout' || key === 'contract_dont_remember') {
                         data[key] = (value === 'yes');
                    } else {
                        data[key] = value;
                    }
                });

                ['goals[]', 'features[]', 'communication_prefs[]'].forEach(arrKey => { if (data[arrKey] && data[arrKey].length === 0) delete data[arrKey]; });
                ['contract_number', 'telegram_username', 'email_for_prize', 'comments', 'storage_days', 'notification_method', 'other_services_details', 'premise_type_other', 'reason_not_using_other', 'goals_other', 'phone_number', 'viber_phone_number'].forEach(optKey => { if (data[optKey] === '') delete data[optKey]; });
                if(data['premise_type'] !== 'Інше') delete data['premise_type_other'];
                if(data['reason_not_using'] !== 'Інше') delete data['reason_not_using_other'];
                if(!data['goals[]'] || !data['goals[]'].includes('Інше')) delete data['goals_other'];
                if(!data['features[]'] || !data['features[]'].includes('Зберігання записів')) delete data['storage_days'];
                if(!data['features[]'] || !data['features[]'].includes('Отримання сповіщень')) delete data['notification_method'];
                if(!data['interested_other_services']) delete data['other_services_details'];
                if(data['is_subscriber'] === 'yes') { delete data['phone_number']; delete data['email_for_prize']; }
                if(!data['communication_prefs[]'] || !data['communication_prefs[]'].includes('viber')) delete data['viber_phone_number'];


                console.log("Collected Form Data:", JSON.stringify(data, null, 2));
                surveyFormSection.style.display = 'none';
                successMessageSection.style.display = 'block';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        });

        // --- Dynamic Input Handling ---

        // Handle Subscriber Yes/No choice
        subscriberRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                const isSubscriber = this.value === 'yes';
                subscriberFields.classList.toggle('visible', isSubscriber);
                nonSubscriberFields.classList.toggle('visible', !isSubscriber);

                if (isSubscriber) {
                    phoneNumberInput.value = ''; emailForPrizeInput.value = '';
                    phoneNumberInput.classList.remove('border-red-500'); emailForPrizeInput.classList.remove('border-red-500');
                } else {
                    contractNumberInput.value = ''; contractDontRememberCheckbox.checked = false;
                     contractNumberInput.classList.remove('border-red-500');
                }
                 if (errorTextElement.textContent.includes('нашим абонентом') || errorTextElement.textContent.includes('телефон АБО email')) hideError();
                 subscriberRadios.forEach(r => r.closest('label')?.classList.remove('border-red-500'));
            });
        });

        // Handle enabling/disabling dependent inputs
        form.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(input => {
            input.addEventListener('change', function(event) {
                const label = this.closest('label');
                const isChecked = this.checked;

                // Generic "Other" text inputs
                const otherInput = label?.querySelector('input[type="text"]:not([name="telegram_username"]):not([name="email_address"]):not([name="email_for_prize"]):not([name="viber_phone_number"]), input[type="number"], textarea');
                if (otherInput) {
                    otherInput.disabled = !isChecked;
                    otherInput.required = isChecked;
                    if (!isChecked) { otherInput.value = ''; otherInput.classList.remove('border-red-500'); }
                    else if (event && event.type === 'change' && otherInput.offsetParent !== null) { otherInput.focus(); }
                }

                // Radio groups disabling other text inputs
                 if (this.type === 'radio' && this.name !== 'is_subscriber') {
                     const radioGroupName = this.name;
                     form.querySelectorAll(`input[type="radio"][name="${radioGroupName}"]`).forEach(radioInGroup => {
                         if (radioInGroup !== this) {
                             const relatedLabel = radioInGroup.closest('label');
                             const relatedOtherInput = relatedLabel?.querySelector('input[type="text"]:not([name="telegram_username"]):not([name="email_address"]):not([name="email_for_prize"]):not([name="viber_phone_number"]), input[type="number"], textarea');
                             if (relatedOtherInput) { relatedOtherInput.disabled = true; relatedOtherInput.required = false; relatedOtherInput.classList.remove('border-red-500'); }
                         }
                     });
                 }

                 // Specific logic for Step 8 (Additional Services) checkbox
                 if (this.id === 'interested-other-services-cb') {
                     toggleConditionalInput(this, otherServicesDetailsContainer, otherServicesDetailsInput, event);
                 }
                 // Specific logic for Step 9 (Communication Preferences) conditional inputs
                 if (this.id === 'comm-email') {
                     toggleConditionalInput(this, emailContainer, emailInput, event);
                 }
                 if (this.id === 'comm-telegram') {
                    toggleConditionalInput(this, telegramContainer, telegramInput, event);
                 }
                 if (this.id === 'comm-viber') { // New logic for Viber
                     toggleConditionalInput(this, viberPhoneContainer, viberPhoneNumberInput, event);
                 }

                 // Uncheck opt-out if another comm pref is selected
                 if (isChecked && this.name === 'communication_prefs[]' && commNoneCheckbox) {
                     commNoneCheckbox.checked = false;
                 }
                 // Uncheck other comm prefs if opt-out is selected
                 if (isChecked && this.id === 'comm-none') {
                     communicationCheckboxes.forEach(cb => { if (cb && cb.checked) { cb.checked = false; cb.dispatchEvent(new Event('change', { bubbles: false })); } });
                 }

            });
        });

        // --- Specific Question Logic ---
        const goalsCheckboxes = form.querySelectorAll('input[name="goals[]"]');
        goalsCheckboxes.forEach(cb => {
            cb.addEventListener('change', () => {
                const checkedCount = form.querySelectorAll('input[name="goals[]"]:checked').length;
                if (checkedCount > 2) { showError("Будь ласка, оберіть не більше двох цілей."); cb.checked = false; cb.dispatchEvent(new Event('change', { bubbles: false })); }
                else { if (errorTextElement.textContent.includes("двох цілей")) hideError(); }
                 if(checkedCount > 0) goalsCheckboxes.forEach(gcb => gcb.closest('label')?.classList.remove('border-red-500'));
            });
        });
        const featuresCheckboxes = form.querySelectorAll('input[name="features[]"]');
        featuresCheckboxes.forEach(cb => {
            cb.addEventListener('change', () => {
                const checkedCount = form.querySelectorAll('input[name="features[]"]:checked').length;
                if (checkedCount > 0) {
                    featuresCheckboxes.forEach(fcb => fcb.closest('label')?.classList.remove('border-red-500'));
                    if (errorTextElement.textContent.includes("одну бажану функцію")) hideError();
                }
            });
        });

        // --- Communication Preferences Logic ---
        const toggleConditionalInput = (checkbox, container, inputElement, event) => {
             if(!checkbox || !container || !inputElement) return;
             const isChecked = checkbox.checked;
             container.classList.toggle('hidden', !isChecked);
             // Make email/viber phone required ONLY if their specific checkbox is checked
             inputElement.required = isChecked && (inputElement.id === 'email-address' || inputElement.id === 'viber-phone-number');
             if (!isChecked) {
                 inputElement.value = '';
                 inputElement.classList.remove('border-red-500');
             } else if (event && event.type === 'change' && inputElement.offsetParent !== null) {
                 // Focus only on user interaction, exclude programmatic changes
                 inputElement.focus();
             }
        };

         // Manually trigger initial state for specific conditional inputs after listeners are set
         toggleConditionalInput(commEmailCheckbox, emailContainer, emailInput, null);
         toggleConditionalInput(commTelegramCheckbox, telegramContainer, telegramInput, null);
         toggleConditionalInput(commViberCheckbox, viberPhoneContainer, viberPhoneNumberInput, null); // Initial state for Viber
         if (interestedOtherServicesCheckbox && otherServicesDetailsContainer && otherServicesDetailsInput) {
              otherServicesDetailsContainer.classList.toggle('hidden', !interestedOtherServicesCheckbox.checked);
              otherServicesDetailsInput.required = interestedOtherServicesCheckbox.checked;
              if (!interestedOtherServicesCheckbox.checked) { otherServicesDetailsInput.value = ''; otherServicesDetailsInput.classList.remove('border-red-500'); }
         }
         // Trigger initial state for any 'Other' inputs associated with checked radios/checkboxes on load (if any)
         form.querySelectorAll('input[type="radio"]:checked, input[type="checkbox"]:checked').forEach(input => {
             const label = input.closest('label');
             const otherInput = label?.querySelector('input[type="text"]:not([name="telegram_username"]):not([name="email_address"]):not([name="email_for_prize"]):not([name="viber_phone_number"]), input[type="number"], textarea');
             if(otherInput) {
                 otherInput.disabled = false;
                 otherInput.required = true;
             }
         });


        // --- Input Validation Highlighting Removal ---
        form.querySelectorAll('input, textarea').forEach(input => {
            input.addEventListener('input', () => {
                const wrapper = (input.type === 'radio' || input.type === 'checkbox') ? input.closest('label') : input;
                if (wrapper && wrapper.classList.contains('border-red-500')) {
                    let shouldRemoveError = false;
                    if (input.type === 'radio') {
                        if (form.querySelector(`input[name="${input.name}"]:checked`)) {
                            shouldRemoveError = true;
                            form.querySelectorAll(`input[name="${input.name}"]`).forEach(radio => radio.closest('label')?.classList.remove('border-red-500'));
                        }
                    } else if (input.type === 'checkbox') {
                        const groupName = input.name;
                         const isGroup = groupName.endsWith('[]');
                         const isChecked = isGroup ? form.querySelector(`input[name="${groupName}"]:checked`) : input.checked;
                        if (isChecked) { shouldRemoveError = true; if(isGroup) form.querySelectorAll(`input[name="${groupName}"]`).forEach(cb => cb.closest('label')?.classList.remove('border-red-500')); else wrapper.classList.remove('border-red-500'); }
                    } else if (input.type === 'email') {
                        if (input.value.trim()) shouldRemoveError = true;
                    } else if (input.type === 'tel') {
                         if (input.value.trim() && isValidPhone(input.value.trim())) shouldRemoveError = true;
                    } else if (input.value.trim()) {
                        shouldRemoveError = true;
                    }

                    if (shouldRemoveError) wrapper.classList.remove('border-red-500');

                    if (currentStep === 1 && form.querySelector('input[name="is_subscriber"][value="no"]:checked')) {
                         const phoneValue = phoneNumberInput.value.trim();
                         const emailValue = emailForPrizeInput.value.trim();
                         if ((phoneValue && isValidPhone(phoneValue)) || (emailValue && isValidEmail(emailValue))) {
                             phoneNumberInput.classList.remove('border-red-500');
                             emailForPrizeInput.classList.remove('border-red-500');
                             if (errorTextElement.textContent.includes('телефон АБО email')) hideError();
                         }
                         if (input === phoneNumberInput && isValidPhone(phoneValue) && errorTextElement.textContent.includes('формат номеру телефону')) hideError();
                         if (input === emailForPrizeInput && isValidEmail(emailValue) && errorTextElement.textContent.includes('формат Email адреси')) hideError();
                    }
                     // Clear Viber phone format error
                     if (input === viberPhoneNumberInput && isValidPhone(input.value.trim()) && errorTextElement.textContent.includes('дійсний номер телефону')) hideError();
                }
            });
             if(input.type === 'radio' || input.type === 'checkbox') {
                 input.addEventListener('change', () => { input.dispatchEvent(new Event('input', { bubbles: false })); });
             }
        });

         // --- Speech Recognition Logic ---
         if (isRecognitionSupported && speechButton && commentsTextarea && speechStatus) {
            speechButton.addEventListener('click', () => {
                try {
                    // Check if recognition is already running before starting
                    // Note: Standard SpeechRecognition doesn't have a reliable 'running' state property.
                    // We manage state via button disabled/class.
                    if (speechButton.disabled) {
                        recognition.stop(); // Attempt to stop if button indicates it's running
                        return;
                    }
                    recognition.start();
                    speechStatus.textContent = 'Слухаю...';
                    speechButton.disabled = true;
                    speechButton.classList.add('listening');
                } catch (error) {
                    // Handle potential errors like "recognition already started"
                    if (error.name === 'InvalidStateError') {
                         // Ignore if already started, or try to stop/restart if needed
                         console.warn("Speech recognition already started?");
                    } else {
                        console.error("Speech recognition start error:", error);
                        speechStatus.textContent = 'Помилка запуску розпізнавання.';
                        speechButton.disabled = false;
                        speechButton.classList.remove('listening');
                    }
                }
            });

            recognition.onresult = (event) => {
                let transcript = '';
                // Concatenate final results
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        transcript += event.results[i][0].transcript;
                    }
                }
                // Append transcript with a space if textarea not empty
                if (transcript) {
                    // Trim existing value and add space only if there's content
                    const currentVal = commentsTextarea.value.trim();
                    commentsTextarea.value = currentVal + (currentVal ? ' ' : '') + transcript.trim();
                    // Trigger input event for potential framework bindings
                    commentsTextarea.dispatchEvent(new Event('input', { bubbles: true }));
                }
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                let errorMessage = 'Помилка розпізнавання.';
                if (event.error === 'no-speech') {
                    errorMessage = 'Нічого не розпізнано. Спробуйте ще.';
                } else if (event.error === 'audio-capture') {
                    errorMessage = 'Помилка мікрофону.';
                } else if (event.error === 'not-allowed') {
                    errorMessage = 'Доступ до мікрофону заборонено.';
                }
                speechStatus.textContent = errorMessage;
                 // Ensure button is re-enabled on error
                 speechButton.disabled = false;
                 speechButton.classList.remove('listening');
            };

            recognition.onend = () => {
                // Clear status and reset button only when recognition truly ends
                speechStatus.textContent = '';
                speechButton.disabled = false;
                speechButton.classList.remove('listening');
            };
         }


        // --- Initialize ---
        updateProgress();

    });
</script>

</body>
</html>
